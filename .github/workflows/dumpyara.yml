name: Dump

on:
  push:
    paths-ignore:
      - '*.md'
    branches: [ main ]

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
       - name: Checkouts
         uses: actions/checkout@v2
       - uses: rokibhasansagar/slimhub_actions@main
       - name: Clone Dumpyara
         run: |
              if [ -f "private.txt" ]
              then
                  git clone --depth=1 --single-branch https://github.com/Box-boi/phoenix_firmware_dumper.git -b private
              else
                  git clone --depth=1 --single-branch https://github.com/Box-boi/phoenix_firmware_dumper.git
              fi
              
              
       - name: Setup Dumpyara environment
         working-directory: phoenix_firmware_dumper
         run: |
              sudo bash setup.sh

       - name: Setup config envs And Begin Dump
         working-directory: phoenix_firmware_dumper
         run: |
              NAME_OF_THIS_REPO="dumper1"
              GITHUB_ORG_NAME="boxaltdump"
              GITLAB_ORG_NAME="boxdumps"
              GITLAB_USERNAME="boxaltdumps"
              GITHUB_USERNAME="box-automation1"
              GIT_CONFIG_USERNAME="Box In A Box"
              GIT_CONFIG_EMAIL="evanferrao@gmail.com"
              GIT_GITHUB_TOKEN="${{ secrets.GIT_GITHUB_TOKEN }}"
              GITLAB_TOKEN="${{ secrets.GITLAB_TOKEN }}"
              TG_BOT_TOKEN="${{ secrets.TG_BOT_TOKEN }}"
              TG_CHAT="@BoxDumps"
              CHAT_REQUEST_ID="@BoxDumpsRequests"  # Your Dump Request Group
              GITLAB_HOSTNAME="gitlab.com" ## use 'gitlab.com' by default, or use your own github instance, or any public one
              echo "$GITHUB_ORG_NAME" > .github_orgname
              echo "$GITLAB_HOSTNAME" > .gitlab_instance
              echo "$GIT_GITHUB_TOKEN" > .github_token
              echo "$CHAT_REQUEST_ID" > .tg_request_chat
              echo "$GITLAB_ORG_NAME" > .gitlab_orgname
              echo "$GITLAB_USERNAME" > .gitlab_username
              echo "$GITHUB_USERNAME" > .github_username
              echo "$GITLAB_TOKEN" > .gitlab_token
              echo "$TG_BOT_TOKEN" > .tg_token
              echo "$TG_CHAT" > .tg_chat
              aria2c -o .tg_chat_id https://raw.githubusercontent.com/${GITHUB_USERNAME}/${NAME_OF_THIS_REPO}/main/CHAT_ID.txt
              aria2c -o .user_first_name https://raw.githubusercontent.com/${GITHUB_USERNAME}/${NAME_OF_THIS_REPO}/main/USER_FIRST_NAME.txt
              aria2c -o .user_id https://raw.githubusercontent.com/${GITHUB_USERNAME}/${NAME_OF_THIS_REPO}/main/USER_ID.txt
              aria2c -o .user_tag https://raw.githubusercontent.com/${GITHUB_USERNAME}/${NAME_OF_THIS_REPO}/main/USER_TAG.txt
              #Do Not Edit This
              git config --global user.name "$GIT_CONFIG_USERNAME"
              git config --global user.email "$GIT_CONFIG_EMAIL"
              sed -i s/"DroidDumps@github.com"/"$GIT_CONFIG_EMAIL"/g dumper.sh
              sed -i s/"user.name \"DroidDumps\""/"user.name \"$GIT_CONFIG_USERNAME\""/g dumper.sh
              #Send Telegram Conformation  #Sends A 'Starting Dump...' Message, and saves the message id to a file, so that, message can be edited live later on
              echo ""$(curl -X POST -H 'Content-Type: application/json' -d "{\"chat_id\": \"$(< .tg_chat_id)\", \"text\": \"Starting Dump...\", \"disable_notification\": true}" https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage | grep -oP "(\"message_id\":)[0-9]+" | cut -d ":" -f 2)"" > .message_id
              sudo bash dumper.sh "$ROM_URL"

env:
  ROM_URL: https://pb82-my.sharepoint.com/personal/aureliendis_t_5tb_in/_layouts/15/download.aspx?UniqueId=dd08a2dc-af5d-4352-a104-4ebe7f86c657&Translate=false&tempauth=eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIwMDAwMDAwMy0wMDAwLTBmZjEtY2UwMC0wMDAwMDAwMDAwMDAvcGI4Mi1teS5zaGFyZXBvaW50LmNvbUBiMTI5NDQ4NS05NDI1LTQ0MmQtYTc3Ny03MDUwYmVkYzliYjYiLCJpc3MiOiIwMDAwMDAwMy0wMDAwLTBmZjEtY2UwMC0wMDAwMDAwMDAwMDAiLCJuYmYiOiIxNjUxNzA2ODAyIiwiZXhwIjoiMTY1MTcxMDQwMiIsImVuZHBvaW50dXJsIjoibUxDN2E1bEVJS29sU2Z2aHNyZndMTVkyV3AxTVZxc3JTS25tMjlCNm5vOD0iLCJlbmRwb2ludHVybExlbmd0aCI6IjE0OCIsImlzbG9vcGJhY2siOiJUcnVlIiwiY2lkIjoiWmpneE5XTXdaall0TmpkalppMDBZakF4TFdFNU5ETXRPREl6TlRabE9XRXpNak15IiwidmVyIjoiaGFzaGVkcHJvb2Z0b2tlbiIsInNpdGVpZCI6Ik5UUTVNamd5TWpjdE9XSTNNeTAwTURsbUxUa3dOemd0TjJVNFltTmlNMlUwWW1ZMCIsImFwcF9kaXNwbGF5bmFtZSI6IndlYmIiLCJzaWduaW5fc3RhdGUiOiJbXCJrbXNpXCJdIiwiYXBwaWQiOiIxY2JiODUwOS04MGVjLTQ2YzUtYTFiZi1lODhhNzhjNTNiZWEiLCJ0aWQiOiJiMTI5NDQ4NS05NDI1LTQ0MmQtYTc3Ny03MDUwYmVkYzliYjYiLCJ1cG4iOiJhdXJlbGllbmRpc0B0LjV0Yi5pbiIsInB1aWQiOiIxMDAzMjAwMUM2OTUwNjVEIiwiY2FjaGVrZXkiOiIwaC5mfG1lbWJlcnNoaXB8MTAwMzIwMDFjNjk1MDY1ZEBsaXZlLmNvbSIsInNjcCI6Im15ZmlsZXMucmVhZCBhbGxmaWxlcy5yZWFkIG15ZmlsZXMud3JpdGUgYWxsZmlsZXMud3JpdGUgYWxscHJvZmlsZXMucmVhZCIsInR0IjoiMiIsInVzZVBlcnNpc3RlbnRDb29raWUiOm51bGwsImlwYWRkciI6IjIwLjE5MC4xMzUuNDUifQ.TFZrM3NYdXpFQ096c1hBQVVJZEdLbDF6anZRR2RkK2JzSlBOOCtTS0ZzTT0&ApiVersion=2.0
